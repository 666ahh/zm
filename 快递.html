<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€’ç±»å‹æ™ºèƒ½åˆ‡æ¢å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .section {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background-color: #fff;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
    }
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .filter-group {
      flex: 1 0 calc(50% - 20px);
      min-width: 300px;
      max-width: calc(50% - 20px);
      box-sizing: border-box;
    }
    .filter-label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    .filter-stats {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .switch-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .switch-group {
      flex: 1;
      min-width: 200px;
    }
    .switch-label {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .switch-checkbox {
      margin-right: 10px;
    }
    .action-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .action-button:hover {
      background-color: #2980b9;
    }
    #resetData {
      background-color: #e74c3c;
    }
    #resetData:hover {
      background-color: #c0392b;
    }
    .stats-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 25px;
    }
    .stats-box {
      flex: 1;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background-color: #fff;
    }
    .stats-title {
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 16px;
    }
    .stats-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #eee;
    }
    .stats-label {
      font-weight: bold;
      color: #555;
    }
    .stats-value {
      text-align: right;
      font-family: 'Courier New', monospace;
    }
    .stats-total {
      font-weight: bold;
      color: #e74c3c;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #eee;
    }
    .file-input-container {
      margin-bottom: 20px;
    }
    .file-input-label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #555;
    }
    .file-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    .info-text {
      font-size: 13px;
      color: #777;
      margin-top: 5px;
    }
    .current-discount-info {
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f8ff;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }
    .switch-direction {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
    }
    .direction-group {
      flex: 1;
      min-width: 200px;
    }
    .discount-rules {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .discount-rule-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .discount-rule-table th, .discount-rule-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .discount-rule-table th {
      background-color: #f2f2f2;
    }
    .discount-rule-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .rule-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .rule-input {
      width: 100px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .add-rule-btn, .remove-rule-btn, .save-rules-btn {
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-rule-btn {
      background-color: #2ecc71;
    }
    .remove-rule-btn {
      background-color: #e74c3c;
    }
    .save-rules-btn {
      background-color: #3498db;
    }
    .rule-editor {
      margin-top: 15px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .type-detail {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
      border-top: 1px dashed #eee;
      padding-top: 3px;
    }
    .filter-count {
      color: #3498db;
      font-weight: bold;
    }
    .filter-total {
      color: #e74c3c;
      font-weight: bold;
    }
    .select-all-btn {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 5px;
    }
    .select-all-btn:hover {
      text-decoration: underline;
    }
    .filter-search-container {
      position: relative;
      margin-bottom: 10px;
    }
    .filter-search-input {
      width: 93%;
      padding: 8px 30px 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-search-clear {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6c757d;
    }
    .filter-search-clear:hover {
      color: #dc3545;
    }
    .filter-options-container {
      border: 1px solid #ced4da;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .filter-option {
      font-size: 13px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      word-break: break-word;
    }
    .filter-option:hover {
      background-color: #f8f9fa;
    }
    .filter-option.selected {
      background-color: #e1f0fa;
    }
    .filter-option-checkbox {
      margin-right: 8px;
    }
    .filter-option-count {
      color: #6c757d;
      font-size: 12px;
    }
    .no-options {
      padding: 10px;
      color: #6c757d;
      text-align: center;
      font-style: italic;
    }
    .filter-group-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    .loading-text {
      font-size: 18px;
      color: #3498db;
      font-weight: bold;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<!-- åœ¨<body>å¼€å¤´æ·»åŠ  -->
<div id="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
  <div class="loading-text">æ•°æ®åŠ è½½ä¸­...</div>
</div>
<div class="container">
  <h1>å¿«é€’ç±»å‹æ™ºèƒ½åˆ‡æ¢å·¥å…·</h1>

  <div class="section">
    <div class="section-title">ğŸ“¤ æ•°æ®ä¸Šä¼ </div>
    <div class="file-input-container">
      <label class="file-input-label" for="fileInput">é€‰æ‹©Excelæ–‡ä»¶:</label>
      <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
      <div class="info-text">è¯·ä¸Šä¼ åŒ…å«å¿«é€’æ•°æ®çš„Excelæ–‡ä»¶ï¼Œç¡®ä¿åŒ…å«å¿«é€’å•å·ã€å¿«é€’ç±»å‹ã€åŸä»·ç­‰å¿…è¦å­—æ®µ</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ” ç­›é€‰æ¡ä»¶</div>
    <div class="filter-container">
      <!-- åœ°åŒºç­›é€‰ -->
      <div class="filter-group">
        <div class="filter-group-title">
          <label class="filter-label">æŒ‰åœ°åŒºç­›é€‰:</label>
          <button class="select-all-btn" onclick="toggleSelectAll('region')">å…¨é€‰/å–æ¶ˆå…¨é€‰</button>
        </div>

        <!-- å·²é€‰æ ‡ç­¾ -->
        <div class="filter-tag-container" id="regionTags"></div>

        <!-- æœç´¢æ¡† -->
        <div class="filter-search-container">
          <input type="text" class="filter-search-input" id="regionSearch"
                 placeholder="æœç´¢åœ°åŒº..." oninput="filterOptions('region', this.value)">
          <span class="filter-search-clear" onclick="clearSearch('region')">Ã—</span>
        </div>

        <!-- é€‰é¡¹åˆ—è¡¨ -->
        <div class="filter-options-container" id="regionOptions"></div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="filter-stats" id="regionStats">
          <span class="filter-count">0ä¸ªåœ°åŒº</span> |
          <span class="filter-count">0ä»¶åŒ…è£¹</span> |
          <span class="filter-total">Â¥0.00</span>
        </div>
      </div>

      <!-- åŒ»é™¢ç­›é€‰ -->
      <div class="filter-group">
        <div class="filter-group-title">
          <label class="filter-label">æŒ‰åŒ»é™¢ç­›é€‰:</label>
          <button class="select-all-btn" onclick="toggleSelectAll('hospital')">å…¨é€‰/å–æ¶ˆå…¨é€‰</button>
        </div>

        <div class="filter-tag-container" id="hospitalTags"></div>

        <div class="filter-search-container">
          <input type="text" class="filter-search-input" id="hospitalSearch"
                 placeholder="æœç´¢åŒ»é™¢..." oninput="filterOptions('hospital', this.value)">
          <span class="filter-search-clear" onclick="clearSearch('hospital')">Ã—</span>
        </div>

        <div class="filter-options-container" id="hospitalOptions"></div>

        <div class="filter-stats" id="hospitalStats">
          <span class="filter-count">0å®¶åŒ»é™¢</span> |
          <span class="filter-count">0ä»¶åŒ…è£¹</span> |
          <span class="filter-total">Â¥0.00</span>
        </div>
      </div>

      <!-- å¿«é€’ç±»å‹ç­›é€‰ -->
      <div class="filter-group">
        <div class="filter-group-title">
          <label class="filter-label">å½“å‰å¿«é€’ç±»å‹:</label>
          <button class="select-all-btn" onclick="toggleSelectAll('expressType')">å…¨é€‰/å–æ¶ˆå…¨é€‰</button>
        </div>

        <div class="filter-tag-container" id="expressTypeTags"></div>

        <div class="filter-search-container">
          <input type="text" class="filter-search-input" id="expressTypeSearch"
                 placeholder="æœç´¢å¿«é€’ç±»å‹..." oninput="filterOptions('expressType', this.value)">
          <span class="filter-search-clear" onclick="clearSearch('expressType')">Ã—</span>
        </div>

        <div class="filter-options-container" id="expressTypeOptions"></div>

        <div class="filter-stats" id="expressTypeStats">
          <span class="filter-count">0ç§ç±»å‹</span> |
          <span class="filter-count">0ä»¶åŒ…è£¹</span> |
          <span class="filter-total">Â¥0.00</span>
        </div>
      </div>

      <!-- æœåŠ¡ç­›é€‰ -->
      <div class="filter-group">
        <div class="filter-group-title">
          <label class="filter-label" style="color: #9a9797">æœåŠ¡ç±»å‹ï¼ˆä»…å±•ç¤ºï¼‰:</label>
        </div>
        <!-- ç¦ç”¨æœç´¢æ¡† -->
        <div class="filter-search-container">
          <input
                  type="text"
                  class="filter-search-input"
                  id="serviceSearch"
                  placeholder="æœç´¢æœåŠ¡..."
                  disabled
          >
          <span class="filter-search-clear" style="display: none;">Ã—</span>
        </div>
        <!-- å…³é”®ä¿®æ”¹ï¼šç¡®ä¿å®¹å™¨å¯æ»šåŠ¨ -->
        <div
                class="filter-options-container"
                id="serviceOptions"
                style="
            user-select: none; /* ç¦æ­¢é¼ æ ‡äº¤äº’ */
            opacity: 0.7; /* é™ä½è§†è§‰å¼ºè°ƒ */
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            max-height: 200px; /* å¿…é¡»è®¾ç½®å›ºå®šé«˜åº¦æ‰èƒ½è§¦å‘æ»šåŠ¨ */
        "
        ></div>
        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="filter-stats" id="serviceStats">
          <span class="filter-count">0ç§æœåŠ¡</span> |
          <span class="filter-count">0ä»¶åŒ…è£¹</span> |
          <span class="filter-total">Â¥0.00</span>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ”„ åˆ‡æ¢é€‰é¡¹</div>

    <div class="switch-direction">
      <div class="direction-group">
        <label class="switch-label">
          <input type="checkbox" id="switchSend" class="switch-checkbox" checked>
          <span>åˆ‡æ¢å¯„ä»¶</span>
        </label>
        <div class="info-text">æ˜¯å¦åˆ‡æ¢å¯„ä»¶ç±»å‹çš„å¿«é€’</div>
      </div>
      <div class="direction-group">
        <label class="switch-label">
          <input type="checkbox" id="switchReceive" class="switch-checkbox" checked>
          <span>åˆ‡æ¢æ”¶ä»¶</span>
        </label>
        <div class="info-text">æ˜¯å¦åˆ‡æ¢æ”¶ä»¶ç±»å‹çš„å¿«é€’</div>
      </div>
    </div>
    <br>

    <div class="switch-container">
      <div class="switch-group">
        <label class="switch-label">
          <input type="checkbox" id="switchUrgent" class="switch-checkbox">
          <span>åŠ æ€¥çŠ¶æ€å½±å“åˆ‡æ¢</span>
        </label>
        <div class="info-text">æ˜¯å¦æ ¹æ®åŠ æ€¥çŠ¶æ€å†³å®šæ˜¯å¦åˆ‡æ¢å¿«é€’ç±»å‹<span class="filter-total">(å‹¾é€‰ï¼Œåˆ™åŠ æ€¥ä»¶ä¸å¯åˆ‡æ¢)</span></div>
      </div>

      <div class="switch-group">
        <label class="switch-label">
          <input type="checkbox" id="switchVip" class="switch-checkbox">
          <span>å…¬ç«‹ã€å¤§å®¢æˆ·å½±å“åˆ‡æ¢</span>
        </label>
        <div class="info-text">æ˜¯å¦æ ¹æ®å¤§å®¢æˆ·çŠ¶æ€å†³å®šæ˜¯å¦åˆ‡æ¢å¿«é€’ç±»å‹<span class="filter-total">(å‹¾é€‰ï¼Œåˆ™å…¬ç«‹ã€å¤§å®¢æˆ·ä»¶ä¸å¯åˆ‡æ¢)</span></div>
      </div>
    </div>

    <div class="switch-buttons">
      <button id="resetData" class="action-button" style="background-color: #e74c3c;">â†©ï¸ é‡ç½®æ•°æ®</button>
      <button id="switchToSF" class="action-button">ğŸ”„ äº¬ä¸œåˆ‡é¡ºä¸°</button>
      <button id="switchToJD" class="action-button">ğŸ”„ é¡ºä¸°åˆ‡äº¬ä¸œ</button>
    </div>
  </div>

  <div class="stats-container">
    <div class="stats-box">
      <div class="stats-title">åˆ‡æ¢å‰ç»Ÿè®¡</div>
      <div id="beforeStats">
        <div class="stats-row">
          <span class="stats-label">é¡ºä¸°:</span>
          <span class="stats-value">0 ä»¶<br>åŸä»·: Â¥0.00<br>æŠ˜æ‰£ä»·: Â¥0.00</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">äº¬ä¸œ:</span>
          <span class="stats-value">0 ä»¶<br>åŸä»·: Â¥0.00<br>æŠ˜æ‰£ä»·: Â¥0.00</span>
        </div>
        <div class="stats-row stats-total">
          <span class="stats-label">æ€»è®¡:</span>
          <span class="stats-value">0 ä»¶<br>åŸä»·: Â¥0.00<br>æŠ˜æ‰£ä»·: Â¥0.00</span>
        </div>
      </div>
    </div>
    <div class="stats-box">
      <div class="stats-title">åˆ‡æ¢åç»Ÿè®¡</div>
      <div id="afterStats">
        <!-- å†…å®¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ’° æŠ˜æ‰£è®¾ç½®ä¸è§„åˆ™</div>

    <div class="current-discount-info" id="currentDiscountInfo">
      è¯·ä¸Šä¼ æ–‡ä»¶åæŸ¥çœ‹å½“å‰æŠ˜æ‰£ç‡ä¿¡æ¯
    </div>

    <div class="discount-rules">
      <button class="save-rules-btn" onclick="saveRules()">ä¿å­˜æ‰€æœ‰è§„åˆ™</button>
      <h3>é¡ºä¸°æŠ˜æ‰£è§„åˆ™ (åŸºäºé‡‘é¢)</h3>
      <div class="rule-editor" id="sfRuleEditor">
        <table class="discount-rule-table" id="sfRulesTable">
          <thead>
          <tr>
            <th>æœ€å¤§é‡‘é¢(å…ƒ)</th>
            <th>æŠ˜æ‰£ç‡(%)</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="sfRulesBody">
          <!-- åŠ¨æ€å¡«å…… -->
          </tbody>
        </table>
        <div class="rule-actions">
          <input type="number" id="sfMaxAmount" class="rule-input" placeholder="æœ€å¤§é‡‘é¢">
          <input type="number" id="sfDiscountRate" class="rule-input" placeholder="æŠ˜æ‰£ç‡(%)" min="0" max="100" step="1">
          <button class="add-rule-btn" onclick="addSfRule()">æ·»åŠ è§„åˆ™</button>
        </div>
      </div>

      <h3 style="margin-top: 20px;">äº¬ä¸œæŠ˜æ‰£è§„åˆ™ (åŸºäºåŒ…è£¹æ•°)</h3>
      <div class="rule-editor" id="jdRuleEditor">
        <table class="discount-rule-table" id="jdRulesTable">
          <thead>
          <tr>
            <th>æœ€å¤§åŒ…è£¹æ•°</th>
            <th>æŠ˜æ‰£ç‡(%)</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="jdRulesBody">
          <!-- åŠ¨æ€å¡«å…… -->
          </tbody>
        </table>
        <div class="rule-actions">
          <input type="number" id="jdMaxCount" class="rule-input" placeholder="æœ€å¤§åŒ…è£¹æ•°">
          <input type="number" id="jdDiscountRate" class="rule-input" placeholder="æŠ˜æ‰£ç‡(%)" min="0" max="100" step="1">
          <button class="add-rule-btn" onclick="addJdRule()">æ·»åŠ è§„åˆ™</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let originalData = [];
  let filteredData = [];
  let beforeSwitchStats = null;

  // é»˜è®¤æŠ˜æ‰£è§„åˆ™
  let discountRules = {
    sf: [
      { max: 350000, rate: 0.8 },
      { max: 500000, rate: 0.7 },
      { max: 750000, rate: 0.65 },
      { max: 1150000, rate: 0.6 },
      { max: Infinity, rate: 0.47 }
    ],
    jd: [
      { max: 399, rate: 0.8 },
      { max: 699, rate: 0.7 },
      { max: 999, rate: 0.65 },
      { max: 1499, rate: 0.6 },
      { max: 1999, rate: 0.55 },
      { max: 3999, rate: 0.5 },
      { max: 5999, rate: 0.45 },
      { max: Infinity, rate: 0.4 }
    ]
  };

  // ç­›é€‰æ•°æ®å­˜å‚¨
  const filterData = {
    region: {
      options: [],
      selected: [],
      searchText: ''
    },
    hospital: {
      options: [],
      selected: [],
      searchText: ''
    },
    expressType: {
      options: [
        { value: 'é¡ºä¸°ç‰¹å¿«', label: 'é¡ºä¸°ç‰¹å¿«', count: 0, total: 0 },
        { value: 'é¡ºä¸°æ ‡å¿«', label: 'é¡ºä¸°æ ‡å¿«', count: 0, total: 0 },
        { value: 'äº¬ä¸œç‰¹å¿«', label: 'äº¬ä¸œç‰¹å¿«', count: 0, total: 0 },
        { value: 'äº¬ä¸œæ ‡å¿«', label: 'äº¬ä¸œæ ‡å¿«', count: 0, total: 0 }
      ],
      selected: ['é¡ºä¸°ç‰¹å¿«', 'é¡ºä¸°æ ‡å¿«', 'äº¬ä¸œç‰¹å¿«', 'äº¬ä¸œæ ‡å¿«'],
      searchText: ''
    },
    service: {  // æ–°å¢æœåŠ¡ç­›é€‰
      options: [],
      selected: [],
      searchText: ''
    }
  };

  // æ–‡ä»¶ä¸Šä¼ å¤„ç†
  let originalDataBackup = []; // ç”¨äºå­˜å‚¨åŸå§‹æ•°æ®å¤‡ä»½

  // æ·»åŠ ä»·æ ¼æ¯”ä¾‹é…ç½®
  let priceRatio = {}; // ä¸å†ç¡¬ç¼–ç ï¼Œæ”¹ä¸ºåŠ¨æ€è®¡ç®—

  function calculatePriceRatios(data) {
    // 1. æŒ‰å¿«é€’ç±»å‹åˆ†ç»„ï¼Œè®¡ç®—å¹³å‡ä»·æ ¼
    const priceStats = {};
    data.forEach(item => {
      const type = item['å¿«é€’ç±»å‹'];
      const price = parseFloat(item['åŸä»·']) || 0;

      if (!priceStats[type]) {
        priceStats[type] = { total: 0, count: 0 };
      }
      priceStats[type].total += price;
      priceStats[type].count++;
    });

    // 2. è®¡ç®—å¹³å‡ä»·æ ¼
    const avgPrices = {};
    Object.keys(priceStats).forEach(type => {
      avgPrices[type] = priceStats[type].total / priceStats[type].count;
    });

    // 3. åŠ¨æ€è®¡ç®—é¡ºä¸°å¯¹äº¬ä¸œçš„å€ç‡
    priceRatio = {
      'é¡ºä¸°ç‰¹å¿«': avgPrices['é¡ºä¸°ç‰¹å¿«'] / avgPrices['äº¬ä¸œç‰¹å¿«'],
      'é¡ºä¸°æ ‡å¿«': avgPrices['é¡ºä¸°æ ‡å¿«'] / avgPrices['äº¬ä¸œæ ‡å¿«'],
      'äº¬ä¸œç‰¹å¿«': 1,  // åŸºå‡†å€¼
      'äº¬ä¸œæ ‡å¿«': 1   // åŸºå‡†å€¼
    };

    console.log('åŠ¨æ€è®¡ç®—çš„ä»·æ ¼æ¯”ä¾‹:', priceRatio);
  }


  // 1. æ•°æ®ç¼“å­˜
  let statsCache = null;
  let lastFilterState = null;

  // åˆå§‹åŒ–é¡µé¢æ—¶åŠ è½½è§„åˆ™
  document.addEventListener('DOMContentLoaded', function() {
    loadRules();
  });

  // åŠ è½½è§„åˆ™åˆ°è¡¨æ ¼
  function loadRules() {
    // åŠ è½½é¡ºä¸°è§„åˆ™
    const sfRulesBody = document.getElementById('sfRulesBody');
    sfRulesBody.innerHTML = '';
    discountRules.sf.forEach((rule, index) => {
      // if (rule.max === Infinity) return; // ä¸æ˜¾ç¤ºæ— ç©·å¤§çš„è§„åˆ™

      const row = document.createElement('tr');
      row.innerHTML = `
                <td><input type="number" class="rule-input" value="${rule.max}" onchange="updateRule('sf', ${index}, 'max', this.value)"></td>
                <td><input type="number" class="rule-input" value="${(rule.rate * 100).toFixed(2)}" min="0" max="100" step="1" onchange="updateRule('sf', ${index}, 'rate', this.value / 100)"></td>
                <td><button class="remove-rule-btn" onclick="removeRule('sf', ${index})">åˆ é™¤</button></td>
            `;
      sfRulesBody.appendChild(row);
    });

    // åŠ è½½äº¬ä¸œè§„åˆ™
    const jdRulesBody = document.getElementById('jdRulesBody');
    jdRulesBody.innerHTML = '';
    discountRules.jd.forEach((rule, index) => {
      // if (rule.max === Infinity) return; // ä¸æ˜¾ç¤ºæ— ç©·å¤§çš„è§„åˆ™

      const row = document.createElement('tr');
      row.innerHTML = `
                <td><input type="number" class="rule-input" value="${rule.max}" onchange="updateRule('jd', ${index}, 'max', this.value)"></td>
                <td><input type="number" class="rule-input" value="${(rule.rate * 100).toFixed(2)}" min="0" max="100" step="1" onchange="updateRule('jd', ${index}, 'rate', this.value / 100)"></td>
                <td><button class="remove-rule-btn" onclick="removeRule('jd', ${index})">åˆ é™¤</button></td>
            `;
      jdRulesBody.appendChild(row);
    });
  }

  // æ·»åŠ é¡ºä¸°è§„åˆ™
  function addSfRule() {
    const maxAmount = parseFloat(document.getElementById('sfMaxAmount').value);
    const discountRate = parseFloat(document.getElementById('sfDiscountRate').value) / 100;

    if (isNaN(maxAmount)) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å¤§é‡‘é¢');
      return;
    }

    if (isNaN(discountRate)) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ˜æ‰£ç‡');
      return;
    }

    // æ·»åŠ åˆ°è§„åˆ™æ•°ç»„
    discountRules.sf = discountRules.sf.filter(rule => rule.max !== Infinity);
    discountRules.sf.push({ max: maxAmount, rate: discountRate });
    discountRules.sf.push({ max: Infinity, rate: discountRules.sf[discountRules.sf.length - 2].rate });

    // æŒ‰maxå€¼æ’åº
    discountRules.sf.sort((a, b) => a.max - b.max);

    // é‡æ–°åŠ è½½è§„åˆ™
    loadRules();

    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('sfMaxAmount').value = '';
    document.getElementById('sfDiscountRate').value = '';
  }

  // æ·»åŠ äº¬ä¸œè§„åˆ™
  function addJdRule() {
    const maxCount = parseInt(document.getElementById('jdMaxCount').value);
    const discountRate = parseFloat(document.getElementById('jdDiscountRate').value) / 100;

    if (isNaN(maxCount)) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å¤§åŒ…è£¹æ•°');
      return;
    }

    if (isNaN(discountRate)) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ˜æ‰£ç‡');
      return;
    }

    // æ·»åŠ åˆ°è§„åˆ™æ•°ç»„
    discountRules.jd = discountRules.jd.filter(rule => rule.max !== Infinity);
    discountRules.jd.push({ max: maxCount, rate: discountRate });
    discountRules.jd.push({ max: Infinity, rate: discountRules.jd[discountRules.jd.length - 2].rate });

    // æŒ‰maxå€¼æ’åº
    discountRules.jd.sort((a, b) => a.max - b.max);

    // é‡æ–°åŠ è½½è§„åˆ™
    loadRules();

    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('jdMaxCount').value = '';
    document.getElementById('jdDiscountRate').value = '';
  }

  // æ›´æ–°è§„åˆ™
  function updateRule(type, index, field, value) {
    if (type === 'sf') {
      if (field === 'max') {
        discountRules.sf[index].max = parseFloat(value);
      } else if (field === 'rate') {
        discountRules.sf[index].rate = parseFloat(value);
      }
    } else if (type === 'jd') {
      if (field === 'max') {
        discountRules.jd[index].max = parseInt(value);
      } else if (field === 'rate') {
        discountRules.jd[index].rate = parseFloat(value);
      }
    }

    // é‡æ–°æ’åºè§„åˆ™
    if (type === 'sf') {
      discountRules.sf.sort((a, b) => a.max - b.max);
    } else if (type === 'jd') {
      discountRules.jd.sort((a, b) => a.max - b.max);
    }
  }

  // åˆ é™¤è§„åˆ™
  function removeRule(type, index) {
    if (type === 'sf') {
      discountRules.sf.splice(index, 1);
      // ç¡®ä¿æœ€åä¸€ä¸ªè§„åˆ™æ˜¯Infinity
      if (discountRules.sf[discountRules.sf.length - 1].max !== Infinity) {
        const lastRate = discountRules.sf[discountRules.sf.length - 1].rate;
        discountRules.sf.push({ max: Infinity, rate: lastRate });
      }
    } else if (type === 'jd') {
      discountRules.jd.splice(index, 1);
      // ç¡®ä¿æœ€åä¸€ä¸ªè§„åˆ™æ˜¯Infinity
      if (discountRules.jd[discountRules.jd.length - 1].max !== Infinity) {
        const lastRate = discountRules.jd[discountRules.jd.length - 1].rate;
        discountRules.jd.push({ max: Infinity, rate: lastRate });
      }
    }

    loadRules();
  }

  // ä¿å­˜æ‰€æœ‰è§„åˆ™åˆ°æœ¬åœ°å­˜å‚¨
  function saveRules() {
    localStorage.setItem('discountRules', JSON.stringify(discountRules));
    alert('æŠ˜æ‰£è§„åˆ™å·²ä¿å­˜');
  }

  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è§„åˆ™
  function loadSavedRules() {
    const savedRules = localStorage.getItem('discountRules');
    if (savedRules) {
      discountRules = JSON.parse(savedRules);
      loadRules();
    }
  }

  // åˆå§‹åŒ–ç­›é€‰é€‰é¡¹
  function initFilters() {
    // åˆå§‹åŒ–åœ°åŒºé€‰é¡¹ - ç°åœ¨åŒ…å«æ—¶æ•ˆå¯¹æ¯”ä¿¡æ¯
    const regionStats = {};
    originalData.forEach(item => {
      const region = item['å§‹å‘åœ°/ç›®çš„åœ°'] || '';
      const price = parseFloat(item['åŸä»·']) || 0;
      const timeComparison = item['æ—¶æ•ˆå¯¹æ¯”'] || 'æ— æ•°æ®';
      const deliveryType=item['å¿«é€’ç±»å‹']
      if (deliveryType.includes('å…¶ä»–è´¹ç”¨')) return;

      if (!regionStats[region]) {
        regionStats[region] = {
          count: 0,
          total: 0,
          timeComparisons: new Set() // ä½¿ç”¨Setå­˜å‚¨ä¸åŒçš„æ—¶æ•ˆå¯¹æ¯”å€¼
        };
      }
      regionStats[region].count++;
      regionStats[region].total += price;
      regionStats[region].timeComparisons.add(timeComparison);
    });

    filterData.region.options = Object.entries(regionStats)
            .sort((a, b) => b[1].count - a[1].count)
            .map(([value, stats]) => ({
              value,
              label: `${value} (æ—¶æ•ˆå¯¹æ¯”:<span class="filter-total"> ${Array.from(stats.timeComparisons).join(', ')}</span>)`,
              count: stats.count,
              total: stats.total,
              timeComparisons: Array.from(stats.timeComparisons)
            }));

    // åˆå§‹åŒ–åŒ»é™¢é€‰é¡¹
    const hospitalStats = {};
    originalData.forEach(item => {
      const hospital = item['åŒ»é™¢'] || '';
      const price = parseFloat(item['åŸä»·']) || 0;
      const deliveryType=item['å¿«é€’ç±»å‹']
      if (deliveryType.includes('å…¶ä»–è´¹ç”¨')) return;
      if (!hospitalStats[hospital]) {
        hospitalStats[hospital] = { count: 0, total: 0 };
      }
      hospitalStats[hospital].count++;
      hospitalStats[hospital].total += price;
    });

    filterData.hospital.options = Object.entries(hospitalStats)
            .sort((a, b) => b[1].count - a[1].count)
            .map(([value, stats]) => ({
              value,
              label: value,
              count: stats.count,
              total: stats.total
            }));

    // åˆå§‹åŒ–å¿«é€’ç±»å‹ç»Ÿè®¡
    const expressTypeStats = {
      'é¡ºä¸°ç‰¹å¿«': { count: 0, total: 0 },
      'é¡ºä¸°æ ‡å¿«': { count: 0, total: 0 },
      'äº¬ä¸œç‰¹å¿«': { count: 0, total: 0 },
      'äº¬ä¸œæ ‡å¿«': { count: 0, total: 0 }
    };

    originalData.forEach(item => {
      const expressType = item['å¿«é€’ç±»å‹'] || '';
      const price = parseFloat(item['åŸä»·']) || 0;
      if (expressTypeStats[expressType]) {
        expressTypeStats[expressType].count++;
        expressTypeStats[expressType].total += price;
      }
    });

    filterData.expressType.options.forEach(option => {
      const stats = expressTypeStats[option.value] || { count: 0, total: 0 };
      option.count = stats.count;
      option.total = stats.total;
    });
    // ä¿æŒå¿«é€’ç±»å‹é»˜è®¤å…¨é€‰
    filterData.expressType.selected = filterData.expressType.options.map(opt => opt.value);
    applyFilters();

    // åˆå§‹åŒ–æœåŠ¡é€‰é¡¹
    const serviceStats = {};
    originalData.forEach(item => {
      const service = item['æœåŠ¡'] || '';
      const price = parseFloat(item['åŸä»·']) || 0;
      if (!serviceStats[service]) {
        serviceStats[service] = { count: 0, total: 0 };
      }
      serviceStats[service].count++;
      serviceStats[service].total += price;
    });

    filterData.service.options = Object.entries(serviceStats)
            .sort((a, b) => b[1].count - a[1].count)
            .map(([value, stats]) => ({
              value,
              label: value,
              count: stats.count,
              total: stats.total
            }));

    // æ¸²æŸ“æ‰€æœ‰ç­›é€‰å™¨
    renderAllFilters();
    updateStats();
  }

  // æ¸²æŸ“æ‰€æœ‰ç­›é€‰å™¨
  function renderAllFilters() {
    renderFilter('region');
    renderFilter('hospital');
    renderFilter('expressType');
    renderFilter('service');
  }

  // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå’Œæ‰¹é‡æ›´æ–°ä¼˜åŒ–DOMæ“ä½œ
  function renderFilter(type) {
    const data = filterData[type];
    const optionsContainer = document.getElementById(`${type}Options`);
    optionsContainer.innerHTML = '';

    const filteredOptions = data.options.filter(option =>
            option.label.toLowerCase().includes(data.searchText.toLowerCase())
    );

    // æ— æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
    if (filteredOptions.length === 0) {
      optionsContainer.innerHTML = '<div class="no-options">æ— åŒ¹é…ç»“æœ</div>';
      return;
    }

    // æ‰¹é‡ç”Ÿæˆé€‰é¡¹
    const optionsFragment = document.createDocumentFragment();
    filteredOptions.forEach(option => {
      const isSelected = data.selected.includes(option.value);
      const optionEl = document.createElement('div');
      optionEl.className = `filter-option ${isSelected ? 'selected' : ''}`;

      // å…³é”®ä¿®æ”¹ï¼šåŒºåˆ†æœåŠ¡å’Œæ™®é€šé€‰é¡¹
      if (type === 'service') {
        // æœåŠ¡é€‰é¡¹ï¼ˆä¸å¯é€‰ï¼‰
        optionEl.innerHTML = `
                <div>
                    <input type="checkbox" class="filter-option-checkbox" disabled>
                    ${option.label}
                </div>
                <span class="filter-option-count">${option.count}ä»¶, Â¥${option.total.toFixed(2)}</span>
            `;
        optionEl.style.pointerEvents = 'auto'; // å…è®¸æ»šåŠ¨
      } else {
        // æ™®é€šé€‰é¡¹ï¼ˆå¯é€‰ï¼‰
        optionEl.innerHTML = `
                <div>
                    <input type="checkbox" class="filter-option-checkbox" ${isSelected ? 'checked' : ''}>
                    ${option.label}
                </div>
                <span class="filter-option-count">${option.count}ä»¶, Â¥${option.total.toFixed(2)}</span>
            `;
        optionEl.onclick = (e) => {
          if (e.target.tagName !== 'INPUT') toggleOption(type, option.value);
        };
        optionEl.querySelector('input').onclick = (e) => {
          e.stopPropagation();
          toggleOption(type, option.value);
        };
      }

      optionsFragment.appendChild(optionEl);
    });

    optionsContainer.appendChild(optionsFragment);
  }

  // åˆ‡æ¢é€‰é¡¹é€‰æ‹©çŠ¶æ€
  function toggleOption(type, value) {
    const data = filterData[type];
    const index = data.selected.indexOf(value);

    if (index === -1) {
      data.selected.push(value);
    } else {
      data.selected.splice(index, 1);
    }

    renderFilter(type);
    updateStats();
    applyFilters();
  }

  // å…¨é€‰/å–æ¶ˆå…¨é€‰
  function toggleSelectAll(type) {
    const data = filterData[type];
    const filteredOptions = data.options.filter(option =>
            option.label.toLowerCase().includes(data.searchText.toLowerCase())
    );

    if (data.selected.length === filteredOptions.length) {
      // å–æ¶ˆå…¨é€‰
      data.selected = [];
    } else {
      // å…¨é€‰å½“å‰å¯è§é€‰é¡¹
      data.selected = filteredOptions.map(opt => opt.value);
    }

    renderFilter(type);
    updateStats();
    applyFilters();
  }

  // ç­›é€‰é€‰é¡¹
  function filterOptions(type, searchText) {
    filterData[type].searchText = searchText;
    renderFilter(type);
  }

  // æ¸…é™¤æœç´¢
  function clearSearch(type) {
    document.getElementById(`${type}Search`).value = '';
    filterData[type].searchText = '';
    renderFilter(type);
  }

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  function updateStats() {
    // åœ°åŒºç»Ÿè®¡
    const regionData = filterData.region;
    const regionCount = regionData.selected.length || regionData.options.length;
    const regionPackageCount = regionData.selected.length > 0
            ? regionData.options
                    .filter(opt => regionData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.count, 0)
            : regionData.options.reduce((sum, opt) => sum + opt.count, 0);
    const regionTotal = regionData.selected.length > 0
            ? regionData.options
                    .filter(opt => regionData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.total, 0)
            : regionData.options.reduce((sum, opt) => sum + opt.total, 0);

    document.getElementById('regionStats').innerHTML = `
            <span class="filter-count">${regionCount}ä¸ªåœ°åŒº</span> |
            <span class="filter-count">${regionPackageCount}ä»¶åŒ…è£¹</span> |
            <span class="filter-total">Â¥${regionTotal.toFixed(2)}</span>
        `;

    // åŒ»é™¢ç»Ÿè®¡
    const hospitalData = filterData.hospital;
    const hospitalCount = hospitalData.selected.length || hospitalData.options.length;
    const hospitalPackageCount = hospitalData.selected.length > 0
            ? hospitalData.options
                    .filter(opt => hospitalData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.count, 0)
            : hospitalData.options.reduce((sum, opt) => sum + opt.count, 0);
    const hospitalTotal = hospitalData.selected.length > 0
            ? hospitalData.options
                    .filter(opt => hospitalData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.total, 0)
            : hospitalData.options.reduce((sum, opt) => sum + opt.total, 0);

    document.getElementById('hospitalStats').innerHTML = `
            <span class="filter-count">${hospitalCount}å®¶åŒ»é™¢</span> |
            <span class="filter-count">${hospitalPackageCount}ä»¶åŒ…è£¹</span> |
            <span class="filter-total">Â¥${hospitalTotal.toFixed(2)}</span>
        `;

    // å¿«é€’ç±»å‹ç»Ÿè®¡
    const expressTypeData = filterData.expressType;
    const expressTypeCount = expressTypeData.selected.length || expressTypeData.options.length;
    const expressTypePackageCount = expressTypeData.selected.length > 0
            ? expressTypeData.options
                    .filter(opt => expressTypeData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.count, 0)
            : expressTypeData.options.reduce((sum, opt) => sum + opt.count, 0);
    const expressTypeTotal = expressTypeData.selected.length > 0
            ? expressTypeData.options
                    .filter(opt => expressTypeData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.total, 0)
            : expressTypeData.options.reduce((sum, opt) => sum + opt.total, 0);

    document.getElementById('expressTypeStats').innerHTML = `
            <span class="filter-count">${expressTypeCount}ç§ç±»å‹</span> |
            <span class="filter-count">${expressTypePackageCount}ä»¶åŒ…è£¹</span> |
            <span class="filter-total">Â¥${expressTypeTotal.toFixed(2)}</span>
        `;

    // æœåŠ¡ç±»å‹ç»Ÿè®¡
    const serviceData = filterData.service;
    const serviceCount = serviceData.selected.length || serviceData.options.length;
    const servicePackageCount = serviceData.selected.length > 0
            ? serviceData.options
                    .filter(opt => serviceData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.count, 0)
            : serviceData.options.reduce((sum, opt) => sum + opt.count, 0);
    const serviceTotal = serviceData.selected.length > 0
            ? serviceData.options
                    .filter(opt => serviceData.selected.includes(opt.value))
                    .reduce((sum, opt) => sum + opt.total, 0)
            : serviceData.options.reduce((sum, opt) => sum + opt.total, 0);

    document.getElementById('serviceStats').innerHTML = `
            <span class="filter-count">${serviceCount}ç§ç±»å‹</span> |
            <span class="filter-count">${servicePackageCount}ä»¶åŒ…è£¹</span> |
            <span class="filter-total">Â¥${serviceTotal.toFixed(2)}</span>
        `;
  }

  // åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶å¤‡ä»½åŸå§‹æ•°æ®
  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.style.display = 'flex';

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      originalData = XLSX.utils.sheet_to_json(firstSheet);

      // ç¡®ä¿æ—¶æ•ˆå¯¹æ¯”åˆ—å­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ ç©ºå€¼
      originalData.forEach(item => {
        if (!item.hasOwnProperty('æ—¶æ•ˆå¯¹æ¯”')) {
          item['æ—¶æ•ˆå¯¹æ¯”'] = 'æ— æ•°æ®';
        }
      });

      originalDataBackup = JSON.parse(JSON.stringify(originalData));
      // åŠ¨æ€è®¡ç®—ä»·æ ¼æ¯”ä¾‹
      calculatePriceRatios(originalData);

      // åˆå§‹åŒ–ç­›é€‰é€‰é¡¹
      initFilters();

      // è®¡ç®—åˆå§‹ç»Ÿè®¡
      beforeSwitchStats = calculateStats();
      renderStats(beforeSwitchStats, 'beforeStats');
      renderStats(calculateStats(), 'afterStats');

      // æ›´æ–°å½“å‰æŠ˜æ‰£ä¿¡æ¯
      updateCurrentDiscountInfo();
      loadingOverlay.style.display = 'none'; // éšè—åŠ è½½åŠ¨ç”»
    };
    reader.readAsArrayBuffer(file);
  });


  // æ›´æ–°å½“å‰æŠ˜æ‰£ä¿¡æ¯
  function updateCurrentDiscountInfo() {
    const sfStats = getSfStats();
    const jdStats = getJdStats();

    const sfDiscount = getSfDiscount(sfStats.total);
    const jdDiscount = getJdDiscount(jdStats.count);

    document.getElementById('currentDiscountInfo').innerHTML = `
            <strong>å½“å‰æŠ˜æ‰£ä¿¡æ¯:</strong><br>
            é¡ºä¸°: æ€»é‡‘é¢ Â¥${sfStats.total.toFixed(2)} (${sfStats.count}ä»¶) â†’ é€‚ç”¨æŠ˜æ‰£ç‡: ${(sfDiscount * 100).toFixed(0)}%<br>
            äº¬ä¸œ: æ€»åŒ…è£¹æ•° ${jdStats.count}ä»¶ (æ€»é‡‘é¢ Â¥${jdStats.total.toFixed(2)}) â†’ é€‚ç”¨æŠ˜æ‰£ç‡: ${(jdDiscount * 100).toFixed(0)}%
        `;
  }

  // è·å–é¡ºä¸°ç»Ÿè®¡æ•°æ®
  function getSfStats() {
    const sfData = originalData.filter(item => item['å¿«é€’ç±»å‹']?.includes('é¡ºä¸°'));
    return {
      count: sfData.length,
      total: sfData.reduce((sum, item) => sum + (parseFloat(item['åŸä»·']) || 0), 0)
    };
  }

  // è·å–äº¬ä¸œç»Ÿè®¡æ•°æ®
  function getJdStats() {
    const jdData = originalData.filter(item => item['å¿«é€’ç±»å‹']?.includes('äº¬ä¸œ'));
    return {
      count: jdData.length,
      total: jdData.reduce((sum, item) => sum + (parseFloat(item['åŸä»·']) || 0), 0)
    };
  }


  // ä¿®æ”¹åˆ‡æ¢æŒ‰é’®çš„äº‹ä»¶å¤„ç†å‡½æ•°
  document.getElementById('switchToSF').addEventListener('click', function() {
    performSwitch('JD_TO_SF');
  });

  document.getElementById('switchToJD').addEventListener('click', function() {
    performSwitch('SF_TO_JD');
  });

  // ç»Ÿä¸€çš„åˆ‡æ¢å¤„ç†å‡½æ•°
  function performSwitch(switchType) {
    const considerUrgent = document.getElementById('switchUrgent').checked;
    const considerVip = document.getElementById('switchVip').checked;
    const switchSend = document.getElementById('switchSend').checked;
    const switchReceive = document.getElementById('switchReceive').checked;

    let switchedCount = 0;

    filteredData.forEach(item => {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢è¯¥æ¡è®°å½•
      let shouldSwitch = true;

      // æ£€æŸ¥å¿«é€’æ–¹å‘
      const isSend = item['ä»˜æ¬¾æ–¹å¼'] === 'å¯„ä»˜';
      if ((isSend && !switchSend) || (!isSend && !switchReceive)) {
        shouldSwitch = false;
      }

      // å¦‚æœè€ƒè™‘åŠ æ€¥çŠ¶æ€ï¼Œä¸”å½“å‰è®°å½•æ˜¯åŠ æ€¥çš„ï¼Œåˆ™ä¸åˆ‡æ¢
      if (considerUrgent && (item['æ˜¯å¦åŠ æ€¥'] === 'æ˜¯' || item['æ˜¯å¦åŠ æ€¥'] === true)) {
        shouldSwitch = false;
      }

      // å¦‚æœè€ƒè™‘å¤§å®¢æˆ·çŠ¶æ€ï¼Œä¸”å½“å‰è®°å½•æ˜¯å¤§å®¢æˆ·çš„ï¼Œåˆ™ä¸åˆ‡æ¢
      if (considerVip && (item['æ˜¯å¦å¤§å®¢æˆ·'] === 'æ˜¯' || item['æ˜¯å¦å¤§å®¢æˆ·'] === true)) {
        shouldSwitch = false;
      }

      if (shouldSwitch) {
        const originalPrice = parseFloat(item['åŸä»·']) || 0;

        if (switchType === 'JD_TO_SF') {
          // äº¬ä¸œåˆ‡é¡ºä¸°
          if (item['å¿«é€’ç±»å‹'] === 'äº¬ä¸œç‰¹å¿«') {
            item['å¿«é€’ç±»å‹'] = 'é¡ºä¸°ç‰¹å¿«';
            item['åŸä»·'] = (originalPrice * priceRatio['é¡ºä¸°ç‰¹å¿«']).toFixed(2);
            switchedCount++;
          } else if (item['å¿«é€’ç±»å‹'] === 'äº¬ä¸œæ ‡å¿«') {
            item['å¿«é€’ç±»å‹'] = 'é¡ºä¸°æ ‡å¿«';
            item['åŸä»·'] = (originalPrice * priceRatio['é¡ºä¸°æ ‡å¿«']).toFixed(2);
            switchedCount++;
          }
        } else if (switchType === 'SF_TO_JD') {
          // é¡ºä¸°åˆ‡äº¬ä¸œ
          if (item['å¿«é€’ç±»å‹'] === 'é¡ºä¸°ç‰¹å¿«') {
            item['å¿«é€’ç±»å‹'] = 'äº¬ä¸œç‰¹å¿«';
            item['åŸä»·'] = (originalPrice / priceRatio['é¡ºä¸°ç‰¹å¿«']).toFixed(2);
            switchedCount++;
          } else if (item['å¿«é€’ç±»å‹'] === 'é¡ºä¸°æ ‡å¿«') {
            item['å¿«é€’ç±»å‹'] = 'äº¬ä¸œæ ‡å¿«';
            item['åŸä»·'] = (originalPrice / priceRatio['é¡ºä¸°æ ‡å¿«']).toFixed(2);
            switchedCount++;
          }
        }
      }
    });

    // å¼ºåˆ¶æ›´æ–°åŸå§‹æ•°æ®
    updateOriginalData();

    // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—
    statsCache = null;
    lastFilterState = null;

    // é‡æ–°è®¡ç®—å¹¶æ˜¾ç¤ºç»Ÿè®¡
    const newStats = calculateStats();
    renderStats(newStats, 'afterStats');
    updateCurrentDiscountInfo();

    alert(`å·²æˆåŠŸåˆ‡æ¢ ${switchedCount} æ¡è®°å½•`);
  }

  // æ›´æ–°åŸå§‹æ•°æ®
  function updateOriginalData() {
    // åˆ›å»ºå¿«é€’å•å·çš„æ˜ å°„ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾
    const trackingNumberMap = {};
    originalData.forEach((item, index) => {
      trackingNumberMap[item['å¿«é€’å•å·']] = index;
    });

    // æ›´æ–°åŸå§‹æ•°æ®
    filteredData.forEach(filteredItem => {
      const index = trackingNumberMap[filteredItem['å¿«é€’å•å·']];
      if (index !== undefined) {
        originalData[index] = {...filteredItem};
      }
    });

    // æ ‡è®°æ•°æ®å·²æ›´æ”¹
    dataChanged = true;
  }

  // é‡ç½®æŒ‰é’®äº‹ä»¶å¤„ç†
  document.getElementById('resetData').addEventListener('click', function() {
    if (originalDataBackup.length === 0) {
      alert('æ²¡æœ‰å¯é‡ç½®çš„åŸå§‹æ•°æ®');
      return;
    }

    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®åˆ°åˆå§‹çŠ¶æ€å—ï¼Ÿè¿™å°†æ’¤é”€æ‰€æœ‰åˆ‡æ¢æ“ä½œã€‚')) {
      // æ¢å¤åŸå§‹æ•°æ®
      originalData = JSON.parse(JSON.stringify(originalDataBackup));

      // é‡ç½®ç­›é€‰æ•°æ®
      filteredData = JSON.parse(JSON.stringify(originalDataBackup));

      // é‡ç½®ç»Ÿè®¡ç¼“å­˜
      statsCache = null;
      lastFilterState = null;

      // é‡æ–°è®¡ç®—ç»Ÿè®¡
      beforeSwitchStats = calculateStats();
      renderStats(beforeSwitchStats, 'beforeStats');
      renderStats(calculateStats(), 'afterStats');

      // æ›´æ–°å½“å‰æŠ˜æ‰£ä¿¡æ¯
      updateCurrentDiscountInfo();

      alert('æ•°æ®å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€');
    }
  });


  // 2. ä¼˜åŒ–ç­›é€‰é€»è¾‘
  function applyFilters() {
    const currentFilterState = JSON.stringify({
      region: filterData.region.selected,
      hospital: filterData.hospital.selected,
      expressType: filterData.expressType.selected
    });

    // å¦‚æœç­›é€‰æ¡ä»¶æœªå˜åŒ–ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜ç»“æœ
    if (lastFilterState === currentFilterState) {
      return;
    }

    lastFilterState = currentFilterState;

    const regionSelected = filterData.region.selected;
    const hospitalSelected = filterData.hospital.selected;
    const expressTypeSelected = filterData.expressType.selected;

    // ä½¿ç”¨æ›´é«˜æ•ˆçš„ç­›é€‰æ–¹æ³•
    filteredData = originalData.filter(item => {
      const regionMatch = regionSelected.length === 0 ||
              regionSelected.includes(item['å§‹å‘åœ°/ç›®çš„åœ°']);
      const hospitalMatch = hospitalSelected.length === 0 ||
              hospitalSelected.includes(item['åŒ»é™¢']);
      const expressMatch = expressTypeSelected.length === 0 ||
              expressTypeSelected.includes(item['å¿«é€’ç±»å‹']);

      return regionMatch && hospitalMatch && expressMatch;
    });

    // æ›´æ–°ç¼“å­˜
    statsCache = calculateStats();
    renderStats(statsCache, 'afterStats');
    updateCurrentDiscountInfo();
  }

  // 3. ä¼˜åŒ–ç»Ÿè®¡è®¡ç®—
  function calculateStats() {
    const stats = {
      'é¡ºä¸°': { count: 0, originalTotal: 0, types: { 'é¡ºä¸°ç‰¹å¿«': 0, 'é¡ºä¸°æ ‡å¿«': 0 } },
      'äº¬ä¸œ': { count: 0, originalTotal: 0, types: { 'äº¬ä¸œç‰¹å¿«': 0, 'äº¬ä¸œæ ‡å¿«': 0 } },
      'æ€»è®¡': { count: 0, originalTotal: 0 }
    };

    // å•æ¬¡éå†è®¡ç®—æ‰€æœ‰ç»Ÿè®¡é‡
    originalData.forEach(item => {
      const expressType = item['å¿«é€’ç±»å‹'] || '';
      const price = parseFloat(item['åŸä»·']) || 0;

      stats['æ€»è®¡'].count++;
      stats['æ€»è®¡'].originalTotal += price;

      if (expressType.includes('é¡ºä¸°')) {
        stats['é¡ºä¸°'].count++;
        stats['é¡ºä¸°'].originalTotal += price;
        if (expressType === 'é¡ºä¸°ç‰¹å¿«') stats['é¡ºä¸°'].types['é¡ºä¸°ç‰¹å¿«']++;
        else if (expressType === 'é¡ºä¸°æ ‡å¿«') stats['é¡ºä¸°'].types['é¡ºä¸°æ ‡å¿«']++;
      } else if (expressType.includes('äº¬ä¸œ')) {
        stats['äº¬ä¸œ'].count++;
        stats['äº¬ä¸œ'].originalTotal += price;
        if (expressType === 'äº¬ä¸œç‰¹å¿«') stats['äº¬ä¸œ'].types['äº¬ä¸œç‰¹å¿«']++;
        else if (expressType === 'äº¬ä¸œæ ‡å¿«') stats['äº¬ä¸œ'].types['äº¬ä¸œæ ‡å¿«']++;
      }
    });

    // è·å–æŠ˜æ‰£ç‡ - ç°åœ¨åŸºäºå½“å‰æ•°æ®å®æ—¶è®¡ç®—
    const sfTotal = stats['é¡ºä¸°'].originalTotal;
    const jdCount = stats['äº¬ä¸œ'].count;

    const sfDiscount = getSfDiscount(sfTotal);
    const jdDiscount = getJdDiscount(jdCount);

    // è®¡ç®—æŠ˜æ‰£ä»·
    stats['é¡ºä¸°'].discountedTotal = stats['é¡ºä¸°'].originalTotal * sfDiscount;
    stats['äº¬ä¸œ'].discountedTotal = stats['äº¬ä¸œ'].originalTotal * jdDiscount;
    stats['æ€»è®¡'].discountedTotal = stats['é¡ºä¸°'].discountedTotal + stats['äº¬ä¸œ'].discountedTotal;

    return {
      stats: stats,
      discounts: { sf: sfDiscount, jd: jdDiscount }
    };
  }

  // 4. ä¼˜åŒ–æŠ˜æ‰£è®¡ç®—
  function getSfDiscount(total) {
    // ç›´æ¥ä¼ å…¥æ€»é‡‘é¢ï¼Œé¿å…é‡å¤è®¡ç®—
    for (const rule of discountRules.sf) {
      if (total <= rule.max) {
        return rule.rate;
      }
    }
    return 0.8;
  }

  function getJdDiscount(count) {
    // ç›´æ¥ä¼ å…¥åŒ…è£¹æ•°ï¼Œé¿å…é‡å¤è®¡ç®—
    for (const rule of discountRules.jd) {
      if (count <= rule.max) {
        return rule.rate;
      }
    }
    return 0.8;
  }

  // 5. æ•°æ®å˜åŒ–æ£€æµ‹
  function hasDataChanged() {
    // å®ç°æ•°æ®å˜åŒ–æ£€æµ‹é€»è¾‘
    // å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤æ‚çš„æ£€æµ‹é€»è¾‘
    return false; // ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦å®ç°
  }

  // 6. æ‰¹é‡DOMæ›´æ–°
  function renderStats(data, elementId) {
    const { stats, discounts } = data;
    const container = document.getElementById(elementId);

    // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæ‰¹é‡æ›´æ–°
    const fragment = document.createDocumentFragment();

    // é¡ºä¸°ç»Ÿè®¡
    const sfRow = document.createElement('div');
    sfRow.className = 'stats-row';
    sfRow.innerHTML = `
        <span class="stats-label">é¡ºä¸° (${discounts.sf * 100}%):</span>
        <span class="stats-value">
            ${stats['é¡ºä¸°'].count} ä»¶<br>
            åŸä»·: Â¥${stats['é¡ºä¸°'].originalTotal.toFixed(2)}<br>
            æŠ˜æ‰£ä»·: Â¥${stats['é¡ºä¸°'].discountedTotal.toFixed(2)}
            <div class="type-detail">
                ç‰¹å¿«: ${stats['é¡ºä¸°'].types['é¡ºä¸°ç‰¹å¿«']}ä»¶ |
                æ ‡å¿«: ${stats['é¡ºä¸°'].types['é¡ºä¸°æ ‡å¿«']}ä»¶
            </div>
        </span>
    `;
    fragment.appendChild(sfRow);

    // äº¬ä¸œç»Ÿè®¡
    const jdRow = document.createElement('div');
    jdRow.className = 'stats-row';
    jdRow.innerHTML = `
        <span class="stats-label">äº¬ä¸œ (${discounts.jd * 100}%):</span>
        <span class="stats-value">
            ${stats['äº¬ä¸œ'].count} ä»¶<br>
            åŸä»·: Â¥${stats['äº¬ä¸œ'].originalTotal.toFixed(2)}<br>
            æŠ˜æ‰£ä»·: Â¥${stats['äº¬ä¸œ'].discountedTotal.toFixed(2)}
            <div class="type-detail">
                ç‰¹å¿«: ${stats['äº¬ä¸œ'].types['äº¬ä¸œç‰¹å¿«']}ä»¶ |
                æ ‡å¿«: ${stats['äº¬ä¸œ'].types['äº¬ä¸œæ ‡å¿«']}ä»¶
            </div>
        </span>
    `;
    fragment.appendChild(jdRow);

    // æ€»è®¡
    const totalRow = document.createElement('div');
    totalRow.className = 'stats-row stats-total';
    totalRow.innerHTML = `
        <span class="stats-label">æ€»è®¡:</span>
        <span class="stats-value">
            ${stats['æ€»è®¡'].count} ä»¶<br>
            åŸä»·: Â¥${stats['æ€»è®¡'].originalTotal.toFixed(2)}<br>
            æŠ˜æ‰£ä»·: Â¥${stats['æ€»è®¡'].discountedTotal.toFixed(2)}
        </span>
    `;
    fragment.appendChild(totalRow);

    // ä¸€æ¬¡æ€§æ›´æ–°DOM
    container.innerHTML = '';
    container.appendChild(fragment);
  }


  // é¡µé¢åŠ è½½æ—¶ä»æœ¬åœ°å­˜å‚¨åŠ è½½è§„åˆ™
  loadSavedRules();

  // ä¸ºæœç´¢è¾“å…¥æ·»åŠ é˜²æŠ–
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // ä¿®æ”¹æœç´¢äº‹ä»¶ç›‘å¬
  document.getElementById('regionSearch').addEventListener('input',
          debounce(function(e) {
            filterOptions('region', e.target.value);
          }, 300)
  );

  // åŒæ ·åº”ç”¨äºå…¶ä»–æœç´¢æ¡†
  document.getElementById('hospitalSearch').addEventListener('input',
          debounce(function(e) {
            filterOptions('hospital', e.target.value);
          }, 300)
  );

  document.getElementById('expressTypeSearch').addEventListener('input',
          debounce(function(e) {
            filterOptions('expressType', e.target.value);
          }, 300)
  );
</script>
</body>
</html>